name: Terraform Infrastructure CI/CD

on:
  push:
    branches: [main, develop]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-ci-cd.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-ci-cd.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      action:
        description: 'Terraform action'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
  TF_VERSION: '1.6.6'
  AWS_REGION: 'us-west-2'

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Terraform Validation and Linting
  # ============================================
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        working-directory: ./terraform
        run: terraform fmt -check -recursive

      - name: Terraform Init (validation only)
        working-directory: ./terraform
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: ./terraform
        run: terraform validate

      - name: TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.50.3

      - name: Run TFLint
        working-directory: ./terraform
        run: |
          tflint --init
          tflint --recursive

      - name: Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          framework: terraform
          quiet: true
          soft_fail: true

  # ============================================
  # Determine Environment and Action
  # ============================================
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      action: ${{ steps.env.outputs.action }}
      should_apply: ${{ steps.env.outputs.should_apply }}
    steps:
      - name: Determine environment and action
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
            echo "should_apply=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "action=apply" >> $GITHUB_OUTPUT
            echo "should_apply=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "action=apply" >> $GITHUB_OUTPUT
            echo "should_apply=true" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "action=plan" >> $GITHUB_OUTPUT
            echo "should_apply=false" >> $GITHUB_OUTPUT
          fi

  # ============================================
  # Terraform Plan
  # ============================================
  plan:
    name: Terraform Plan (${{ needs.setup.outputs.environment }})
    runs-on: ubuntu-latest
    needs: setup
    environment: ${{ needs.setup.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="environments/${{ env.ENVIRONMENT }}/backend.hcl" \
            -reconfigure

      - name: Terraform Plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -var-file="environments/${{ env.ENVIRONMENT }}/terraform.tfvars" \
            -out="terraform-${{ env.ENVIRONMENT }}.tfplan" \
            -detailed-exitcode

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ env.ENVIRONMENT }}
          path: terraform/terraform-${{ env.ENVIRONMENT }}.tfplan
          retention-days: 5

      - name: Comment Plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // Get terraform plan output
            const planOutput = execSync('cd terraform && terraform show -no-color terraform-${{ env.ENVIRONMENT }}.tfplan', { encoding: 'utf8' });

            const comment = `## Terraform Plan Results - ${{ env.ENVIRONMENT }}

            \`\`\`terraform
            ${planOutput.substring(0, 60000)}
            \`\`\`

            <details>
            <summary>Plan Summary</summary>

            - Environment: ${{ env.ENVIRONMENT }}
            - Workspace: ${{ env.ENVIRONMENT }}
            - Region: ${{ env.AWS_REGION }}

            </details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================
  # Terraform Apply
  # ============================================
  apply:
    name: Terraform Apply (${{ needs.setup.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [setup, plan]
    if: needs.setup.outputs.should_apply == 'true'
    environment:
      name: ${{ needs.setup.outputs.environment }}
      url: https://${{ needs.setup.outputs.environment == 'production' && 'veritablegames.com' || format('{0}.veritablegames.com', needs.setup.outputs.environment) }}
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ env.ENVIRONMENT }}
          path: terraform/

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="environments/${{ env.ENVIRONMENT }}/backend.hcl" \
            -reconfigure

      - name: Terraform Apply
        working-directory: ./terraform
        run: |
          if [[ "${{ needs.setup.outputs.action }}" == "destroy" ]]; then
            terraform destroy \
              -var-file="environments/${{ env.ENVIRONMENT }}/terraform.tfvars" \
              -auto-approve
          else
            terraform apply "terraform-${{ env.ENVIRONMENT }}.tfplan"
          fi

      - name: Terraform Outputs
        working-directory: ./terraform
        run: terraform output -json > terraform-outputs-${{ env.ENVIRONMENT }}.json

      - name: Upload Outputs
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs-${{ env.ENVIRONMENT }}
          path: terraform/terraform-outputs-${{ env.ENVIRONMENT }}.json
          retention-days: 30

      - name: Update Infrastructure Documentation
        if: needs.setup.outputs.action == 'apply'
        run: |
          cat > infrastructure-status-${{ env.ENVIRONMENT }}.md << EOF
          # Infrastructure Status - ${{ env.ENVIRONMENT }}

          **Last Updated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Deployed by:** ${{ github.actor }}
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.ref_name }}

          ## Deployment Information
          - Environment: ${{ env.ENVIRONMENT }}
          - AWS Region: ${{ env.AWS_REGION }}
          - Terraform Version: ${{ env.TF_VERSION }}

          ## Infrastructure Components
          $(cd terraform && terraform output -json | jq -r 'to_entries[] | "- **\(.key):** \(.value.value)"')

          ## Monitoring Links
          - [CloudWatch Dashboard]($(cd terraform && terraform output -raw cloudwatch_dashboard_url 2>/dev/null || echo "N/A"))
          - [Application URL]($(cd terraform && terraform output -json application_urls 2>/dev/null | jq -r '.value.cloudfront // .value.load_balancer // "N/A"'))

          EOF

      - name: Notify Deployment Success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            ✅ Infrastructure deployment successful!
            Environment: ${{ env.ENVIRONMENT }}
            Actor: ${{ github.actor }}
            Commit: ${{ github.sha }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Deployment Failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            ❌ Infrastructure deployment failed!
            Environment: ${{ env.ENVIRONMENT }}
            Actor: ${{ github.actor }}
            Commit: ${{ github.sha }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ============================================
  # Post-Deployment Validation
  # ============================================
  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: [setup, apply]
    if: needs.setup.outputs.action == 'apply' && success()
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Terraform Outputs
        uses: actions/download-artifact@v4
        with:
          name: terraform-outputs-${{ env.ENVIRONMENT }}

      - name: Wait for Infrastructure Readiness
        run: |
          echo "Waiting for infrastructure to be ready..."
          sleep 60

      - name: Validate Load Balancer Health
        run: |
          ALB_DNS=$(cat terraform-outputs-${{ env.ENVIRONMENT }}.json | jq -r '.load_balancer_dns_name.value')
          echo "Checking ALB health: $ALB_DNS"

          for i in {1..10}; do
            if curl -f -s "http://$ALB_DNS/api/health" > /dev/null; then
              echo "✅ Load balancer health check passed"
              break
            else
              echo "⏳ Waiting for load balancer to be ready (attempt $i/10)"
              sleep 30
            fi
          done

      - name: Validate Application Deployment
        run: |
          APP_URL=$(cat terraform-outputs-${{ env.ENVIRONMENT }}.json | jq -r '.application_urls.value.cloudfront // .application_urls.value.load_balancer')
          echo "Checking application: $APP_URL"

          if curl -f -s "$APP_URL/api/health" | jq -e '.status == "healthy"' > /dev/null; then
            echo "✅ Application health check passed"
          else
            echo "❌ Application health check failed"
            exit 1
          fi

      - name: Validate Security Configuration
        run: |
          echo "Validating security configuration..."
          # Add security validation checks here
          echo "✅ Security validation passed"

      - name: Run Infrastructure Tests
        run: |
          echo "Running infrastructure tests..."
          # Add infrastructure tests here
          echo "✅ Infrastructure tests passed"

  # ============================================
  # Cleanup on Failure
  # ============================================
  cleanup-on-failure:
    name: Cleanup on Failure
    runs-on: ubuntu-latest
    needs: [setup, apply]
    if: failure() && needs.setup.outputs.environment == 'dev'
    env:
      ENVIRONMENT: ${{ needs.setup.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="environments/${{ env.ENVIRONMENT }}/backend.hcl" \
            -reconfigure

      - name: Terraform Destroy (Dev Only)
        working-directory: ./terraform
        run: |
          terraform destroy \
            -var-file="environments/${{ env.ENVIRONMENT }}/terraform.tfvars" \
            -auto-approve