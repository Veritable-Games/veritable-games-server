# CSRF Vulnerability Audit - October 8, 2025

## Executive Summary

**Status**: âš ï¸ **CRITICAL VULNERABILITIES FOUND**

**Protected**: 4/33 files (12%)
**Vulnerable**: 29 files with POST/PATCH/DELETE operations
**Attack Surface**: 80+ state-changing operations without CSRF protection

---

## Current Protection Status

### âœ… Protected (4 files)
1. `src/app/forums/create/page.tsx` - Topic creation
2. `src/components/forums/ReplyList.tsx` - Reply CRUD
3. `src/components/forums/TopicView.tsx` - Topic edit/delete
4. `src/components/forums/TagSelector.tsx` - Tag creation

### âŒ Vulnerable (29 files)

---

## Vulnerability Breakdown by Severity

### ðŸ”´ P0 - CRITICAL (Authentication & Account Security)

**Files**: 5 files, ~15 operations
**Risk**: Account takeover, unauthorized access, credential theft
**Impact**: Users can be forced to log in/out, change passwords, delete accounts

1. **`src/contexts/AuthContext.tsx`**
   - POST /api/auth/login
   - POST /api/auth/logout
   - POST /api/auth/register

2. **`src/components/auth/LoginForm.tsx`**
   - POST /api/auth/login

3. **`src/components/auth/RegisterForm.tsx`**
   - POST /api/auth/register

4. **`src/components/auth/UnifiedLoginWidget.tsx`**
   - POST /api/auth/login

5. **`src/stores/auth.ts`**
   - POST /api/auth/login
   - POST /api/auth/logout

**Recommended Action**: Migrate immediately (today)

---

### ðŸŸ  P1 - HIGH (User Settings & Profile)

**Files**: 3 files, ~8 operations
**Risk**: Profile defacement, privacy settings changed, account settings modified
**Impact**: Users can be forced to change email, password, privacy settings

1. **`src/components/settings/ProfileSettingsForm.tsx`**
   - POST /api/users/profile/avatar
   - PUT /api/users/profile

2. **`src/components/settings/AccountSettingsForm.tsx`**
   - PUT /api/users/account/email
   - PUT /api/users/account/password

3. **`src/components/settings/PrivacySettingsForm.tsx`**
   - PUT /api/users/privacy

**Recommended Action**: Migrate within 48 hours

---

### ðŸŸ  P1 - HIGH (Content Management - Wiki)

**Files**: 4 files, ~10 operations
**Risk**: Wiki vandalism, content deletion, unauthorized edits
**Impact**: Users can be forced to create/edit/delete wiki pages

1. **`src/app/wiki/create/page.tsx`**
   - POST /api/wiki/pages

2. **`src/app/wiki/[slug]/edit/page.tsx`**
   - PUT /api/wiki/pages/[slug]

3. **`src/app/wiki/[slug]/page.tsx`**
   - DELETE /api/wiki/pages/[slug]

4. **`src/app/wiki/[slug]/history/page.tsx`**
   - POST /api/wiki/pages/[slug]/restore
   - DELETE /api/wiki/revisions/[id]

**Recommended Action**: Migrate within 48 hours

---

### ðŸŸ  P1 - HIGH (Content Management - Library)

**Files**: 5 files, ~12 operations
**Risk**: Document deletion, unauthorized uploads, content manipulation
**Impact**: Users can be forced to create/edit/delete library documents

1. **`src/app/library/create/page.tsx`**
   - POST /api/library/documents

2. **`src/app/library/[slug]/edit/page.tsx`**
   - PUT /api/library/documents/[slug]

3. **`src/app/library/[slug]/page.tsx`**
   - DELETE /api/library/documents/[slug]

4. **`src/app/library/page.tsx`**
   - POST /api/library/documents
   - PUT /api/library/documents/[id]
   - DELETE /api/library/documents/[id]
   - PUT /api/library/collections/[id]
   - DELETE /api/library/collections/[id]

5. **`src/components/library/CreateDocumentModal.tsx`**
   - POST /api/library/documents

**Recommended Action**: Migrate within 48 hours

---

### ðŸŸ¡ P2 - MEDIUM (Project Management)

**Files**: 4 files, ~15 operations
**Risk**: Project corruption, version control issues, unauthorized changes
**Impact**: Users can be forced to create/delete project revisions

1. **`src/app/projects/[slug]/page.tsx`**
   - PUT /api/projects/[slug]

2. **`src/contexts/ProjectVersioningContext.tsx`**
   - POST /api/projects/[slug]/revisions
   - POST /api/projects/[slug]/revisions/[id]/restore
   - PUT /api/projects/[slug]/revisions/[id]
   - DELETE /api/projects/[slug]/revisions/[id]
   - POST /api/projects/[slug]/compare

3. **`src/components/projects/revision-manager/useRevisionActions.ts`**
   - POST /api/projects/[slug]/revisions
   - DELETE /api/projects/[slug]/revisions/[id]

4. **`src/stores/project-versioning.ts`**
   - POST /api/projects/[slug]/revisions
   - POST /api/projects/[slug]/compare

**Recommended Action**: Migrate within 1 week

---

### ðŸŸ¡ P2 - MEDIUM (Tags & References)

**Files**: 4 files, ~8 operations
**Risk**: Tag manipulation, reference system corruption
**Impact**: Users can be forced to create/edit/delete tags

1. **`src/components/references/TagFilters.tsx`**
   - POST /api/references/tags
   - DELETE /api/references/tags/[id]

2. **`src/components/references/tags/TagActions.tsx`**
   - POST /api/references/tags

3. **`src/components/references/tags/hooks/useTagMutations.ts`**
   - PATCH /api/references/tags/[id]

4. **`src/components/references/DeleteImageDialog.tsx`**
   - DELETE /api/references/images/[id]

**Recommended Action**: Migrate within 1 week

---

### ðŸŸ¡ P2 - MEDIUM (Annotations)

**Files**: 2 files, ~6 operations
**Risk**: Annotation manipulation, data corruption
**Impact**: Users can be forced to create/edit/delete annotations

1. **`src/contexts/AnnotationContext.tsx`**
   - POST /api/annotations
   - PUT /api/annotations/[id]
   - DELETE /api/annotations/[id]
   - DELETE /api/annotations/bulk

2. **`src/stores/annotation.ts`**
   - POST /api/annotations

**Recommended Action**: Migrate within 1 week

---

### ðŸŸ¢ P3 - LOW (Workspace)

**Files**: 1 file, ~2 operations
**Risk**: Workspace state corruption
**Impact**: Users can be forced to save/update workspace state

1. **`src/components/workspace/WorkspaceCanvas.tsx`**
   - PUT /api/workspace/state
   - PUT /api/workspace/nodes/[id]

**Recommended Action**: Migrate when convenient

---

## Migration Priority Plan

### Week 1 (Oct 8-14, 2025) - CRITICAL
- [ ] **Day 1-2**: Authentication (5 files) - MOST CRITICAL
  - AuthContext, LoginForm, RegisterForm, UnifiedLoginWidget, auth store
- [ ] **Day 3-4**: User Settings (3 files)
  - ProfileSettings, AccountSettings, PrivacySettings

### Week 2 (Oct 15-21, 2025) - HIGH
- [ ] **Day 1-3**: Wiki (4 files)
  - Create, Edit, Delete, History
- [ ] **Day 4-5**: Library (5 files)
  - Create, Edit, Delete, Collections, Modal

### Week 3 (Oct 22-28, 2025) - MEDIUM
- [ ] **Day 1-2**: Projects (4 files)
- [ ] **Day 3**: Tags & References (4 files)
- [ ] **Day 4**: Annotations (2 files)
- [ ] **Day 5**: Workspace (1 file)

---

## Quick Fix Template

```typescript
// BEFORE (Vulnerable):
const response = await fetch('/api/endpoint', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(data),
});
const result = await response.json();

// AFTER (Protected):
import { fetchJSON } from '@/lib/utils/csrf';

const result = await fetchJSON('/api/endpoint', {
  method: 'POST',
  body: data,
});
```

**Time per file**: ~10-15 minutes
**Total estimated time**: 5-8 hours for all files

---

## Risk Assessment

### Without CSRF Protection

**Attack Scenario**:
1. Attacker creates malicious site with hidden form
2. User visits malicious site while logged in
3. Form auto-submits POST request to your API
4. User's browser includes session cookie
5. **Your API accepts the request as legitimate**

**Real-World Impact**:
- User accounts compromised
- Content deleted or vandalized
- Privacy settings changed
- Unwanted actions performed
- Reputation damage

### With CSRF Protection

All POST/PATCH/DELETE requests require:
1. Valid session cookie (existing)
2. **CSRF token in request header** (NEW)
3. Token match validation (server-side)

**Result**: Attackers cannot forge requests even with session cookie

---

## Testing Checklist

After each migration:
- [ ] Verify CSRF cookie is set (DevTools > Application > Cookies)
- [ ] Check `x-csrf-token` header in Network tab
- [ ] Test the operation works (create/edit/delete)
- [ ] Test error handling (clear cookies, retry)
- [ ] Verify no console errors

---

## Progress Tracking

**Total Files**: 33
**Protected**: 4 (12%)
**Remaining**: 29 (88%)

**By Priority**:
- P0 (Critical): 0/5 protected (0%)
- P1 (High): 0/12 protected (0%)
- P2 (Medium): 0/10 protected (0%)
- P3 (Low): 0/1 protected (0%)
- Forums: 4/4 protected (100%) âœ…

---

## References

- CSRF Utilities: `/src/lib/utils/csrf.ts`
- Migration Guide: `/frontend/CSRF_MIGRATION_GUIDE.md`
- Security Middleware: `/src/lib/security/middleware.ts`

---

**Document Version**: 1.0
**Created**: October 8, 2025
**Status**: Active - Migration in progress
**Next Review**: October 15, 2025
