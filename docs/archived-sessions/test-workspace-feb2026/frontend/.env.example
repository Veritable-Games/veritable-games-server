# Veritable Games Platform - Environment Configuration
# Copy this file to .env.local and fill in with your actual values
# NEVER commit .env.local to version control

# ‚ö†Ô∏è CRITICAL: PRODUCTION DEPLOYMENT CHECKLIST ‚ö†Ô∏è
# Before deploying to Vercel/production, you MUST:
# 1. Set DATABASE_MODE=postgres (NOT sqlite - serverless has no persistent filesystem)
# 2. Set POSTGRES_URL to Neon pooled connection string
# 3. Generate new secrets: SESSION_SECRET, CSRF_SECRET, ENCRYPTION_KEY
# 4. Set NODE_ENV=production
# 5. Set NEXT_PUBLIC_SITE_URL to your production domain
# 6. For serverless: POSTGRES_POOL_MAX=1, POSTGRES_POOL_MIN=0
# 7. Increase POSTGRES_CONNECTION_TIMEOUT=10000 (for cold starts)

# ===== DATABASE CONFIGURATION =====
# ‚ö†Ô∏è SQLite Configuration (LOCALHOST DEVELOPMENT ONLY - NEVER USE IN PRODUCTION)
# These paths are ONLY used for local development on localhost:3000
# Production deployments MUST use PostgreSQL (see POSTGRES_URL below)
DB_PATH=./data/forums.db
DATABASE_PATH=data/forums.db
USERS_DATABASE_PATH=data/users.db
WIKI_DATABASE_PATH=data/wiki.db
LIBRARY_DATABASE_PATH=data/library.db
# Note: notebooks.db was renamed to library.db

# ===== POSTGRESQL CONFIGURATION (Migration Target) =====
# Choose ONE of the following providers:

# Option 1: Neon (RECOMMENDED - Free tier: 0.5GB, unlimited compute)
# Get from: https://neon.tech
# POSTGRES_URL="postgresql://user:password@ep-xxx.us-east-2.aws.neon.tech/veritable_games?sslmode=require"

# Option 2: Supabase (Free tier: 500MB, unlimited requests)
# Get from: https://supabase.com/dashboard/project/_/settings/database
# POSTGRES_URL="postgresql://postgres:password@db.xxx.supabase.co:5432/postgres"

# Option 3: Railway (Free: $5 credit/month)
# Get from: Railway dashboard
# POSTGRES_URL="postgresql://postgres:password@containers-us-west-xxx.railway.app:7432/railway"

# Option 4: Vercel Postgres (Free: 256MB, 60 compute hours)
# Auto-populated by: vercel env pull .env.local
POSTGRES_URL=""
POSTGRES_PRISMA_URL=""
POSTGRES_URL_NON_POOLING=""

# Option 5: Self-hosted
# POSTGRES_URL="postgresql://user:password@your-server-ip:5432/veritable_games"

# Common PostgreSQL settings (auto-detected from POSTGRES_URL)
POSTGRES_HOST=""
POSTGRES_PORT="5432"
POSTGRES_DATABASE=""
POSTGRES_USER=""
POSTGRES_PASSWORD=""

# PostgreSQL Connection Pool Settings
# For local development (traditional server):
POSTGRES_POOL_MAX=20
POSTGRES_POOL_MIN=2
POSTGRES_IDLE_TIMEOUT=30000
POSTGRES_CONNECTION_TIMEOUT=5000
POSTGRES_SSL=true
#
# üìù PRODUCTION (Vercel/Serverless) - Override in Vercel dashboard:
# POSTGRES_POOL_MAX=1        # 1 connection per serverless instance
# POSTGRES_POOL_MIN=0        # No minimum (let Vercel manage lifecycle)
# POSTGRES_CONNECTION_TIMEOUT=10000  # 10s for cold starts
# Auto-detected by pool-postgres.ts when VERCEL env var is present

# For local development (Docker Compose)
# Override these in .env.local when using local PostgreSQL
# POSTGRES_URL=postgresql://postgres:postgres@localhost:5432/veritable_games
# POSTGRES_SSL=false

# ===== DATABASE OPERATION MODE (DEPRECATED) =====
# ‚ö†Ô∏è NOTE: DATABASE_MODE environment variable is LEGACY and NO LONGER CHECKED by code
# The adapter.ts hardcodes PostgreSQL-only mode (see lines 69-81)
# This variable is kept for documentation purposes only
#
# Database operation mode: 'sqlite' | 'postgres' | 'dual-write'
# - sqlite: NEVER USE - SQLite is development localhost-only (NOT production-safe)
# - postgres: CORRECT - Use PostgreSQL for all deployments (REQUIRED)
# - dual-write: DEPRECATED - Migration validation mode (no longer used)
#
# ‚ö†Ô∏è CRITICAL: Production MUST use PostgreSQL - SQLite will NOT WORK:
# - No persistent filesystem in serverless (Vercel, Cloudflare)
# - Local SQLite files unavailable in Docker containers
# - adapter.ts will crash with fatal error if POSTGRES_URL is missing
DATABASE_MODE=postgres

# Dual-write settings (only active when DATABASE_MODE=dual-write)
DUAL_WRITE_ENABLED=false
DUAL_WRITE_VALIDATION=true
DUAL_WRITE_LOG_DISCREPANCIES=true

# Migration batch processing
MIGRATION_BATCH_SIZE=1000
MIGRATION_VALIDATE=true
MIGRATION_DRY_RUN=false
MIGRATION_RESUME_ON_ERROR=true

# Performance monitoring
ENABLE_QUERY_PERFORMANCE_TRACKING=false
QUERY_PERFORMANCE_THRESHOLD_MS=1000

# ===== SECURITY CONFIGURATION =====
# Generate with: openssl rand -hex 32
SESSION_SECRET=REPLACE_WITH_GENERATED_SECRET_USE_OPENSSL_RAND_HEX_32

# Database Encryption at Rest (Phase 1.2)
# Enable/disable database encryption
DATABASE_ENCRYPTION_ENABLED=false
# Master key for database encryption (generate with: openssl rand -hex 32)
DATABASE_MASTER_KEY=REPLACE_WITH_DATABASE_MASTER_KEY_OPENSSL_RAND_HEX_32
# Key derivation iterations (NIST recommended minimum: 100000)
KEY_DERIVATION_ROUNDS=100000
# Key rotation interval in days
KEY_ROTATION_INTERVAL_DAYS=90
# Number of old key backups to retain
KEY_BACKUP_COUNT=5

# Generate with: openssl rand -hex 32
CSRF_SECRET=REPLACE_WITH_GENERATED_SECRET_USE_OPENSSL_RAND_HEX_32

# Generate with: openssl rand -hex 32
ENCRYPTION_KEY=REPLACE_WITH_GENERATED_KEY_USE_OPENSSL_RAND_HEX_32

# ===== EMERGENCY ACCESS CONFIGURATION =====
# Emergency secret for admin recovery endpoints (e.g., clearing 2FA rate limits)
# This allows recovery when admin is locked out without database access
# Generate with: openssl rand -hex 32
EMERGENCY_SECRET=REPLACE_WITH_GENERATED_SECRET_USE_OPENSSL_RAND_HEX_32

# ===== COOKIE SECURITY CONFIGURATION =====
# Control cookie Secure flag behavior
# - Default: Enabled in production (secure=true), disabled in development (secure=false)
# - Override: Set COOKIE_SECURE_FLAG=false for HTTP-only production deployments
# - IMPORTANT: Only disable for local HTTP deployments (like Coolify without SSL)
# - When HTTPS is configured, remove this override to restore security
#
# Current Production Setup (November 2025):
# - Server: http://192.168.1.15:3000 (HTTP only, no SSL)
# - Required: COOKIE_SECURE_FLAG=false
# - When SSL added: Remove this variable to default to secure=true
#
COOKIE_SECURE_FLAG=false

# Cookie __Secure- prefix control (PRODUCTION FIX)
# Browsers enforce that __Secure- cookies REQUIRE HTTPS connections
# For HTTP-only deployments (like Coolify without SSL), set this to false
# to use 'session_id' instead of '__Secure-session_id'
#
# - false (DEFAULT): Use 'session_id' - compatible with HTTP (Coolify development)
# - true: Use '__Secure-session_id' - REQUIRES HTTPS (production with SSL)
#
# Background:
# The code defaults to false, so you typically don't need to set this.
# Only set to 'true' after configuring HTTPS/SSL on your production server.
#
# Current Status (November 2025):
# - Production: http://192.168.1.15:3000 (HTTP only, no SSL)
# - Set: COOKIE_USE_SECURE_PREFIX=false (or omit - false is default)
# - After SSL: Set COOKIE_USE_SECURE_PREFIX=true
#
COOKIE_USE_SECURE_PREFIX=false

# ===== DATABASE ENCRYPTION CONFIGURATION =====
# Enable database encryption at rest using SQLCipher
DATABASE_ENCRYPTION_ENABLED=false

# Master key for database encryption (64+ hex characters)
# Generate with: openssl rand -hex 32
# CRITICAL: Keep this secret secure and backed up!
DATABASE_MASTER_KEY=REPLACE_WITH_GENERATED_MASTER_KEY_64_HEX_CHARS

# Encryption key rotation policy (days)
KEY_ROTATION_CRITICAL_DAYS=30
KEY_ROTATION_NORMAL_DAYS=90
KEY_ROTATION_LOW_DAYS=180

# Automatic key rotation (set to 'true' to enable scheduled rotation)
ENABLE_AUTO_KEY_ROTATION=false

# Key derivation iterations (NIST recommended minimum: 100000)
KEY_DERIVATION_ITERATIONS=100000

# Encryption health monitoring
ENCRYPTION_HEALTH_MONITORING=true
ENCRYPTION_HEALTH_CHECK_INTERVAL=30000

# Performance monitoring thresholds
MAX_ENCRYPTION_OVERHEAD_PERCENT=5
ENCRYPTION_PERFORMANCE_ALERTS=true

# ===== APPLICATION CONFIGURATION =====
# Environment: 'development' | 'staging' | 'production'
NODE_ENV=development

# Application domain (no trailing slash)
NEXTAUTH_URL=http://localhost:3000
NEXT_PUBLIC_SITE_URL=http://localhost:3000
NEXT_PUBLIC_API_URL=http://localhost:3000/api
NEXT_PUBLIC_WEBSOCKET_URL=http://localhost:3001

# ===== WEBSOCKET CONFIGURATION =====
WEBSOCKET_PORT=3001
WEBSOCKET_CORS_ORIGIN=http://localhost:3000

# ===== WORKSPACE MULTI-USER COLLABORATION (Phase 6) =====
# WebSocket server for real-time Yjs sync in the infinite canvas
# Requires: websocket-server.ts running on port 3002
#
# Enable WebSocket synchronization (default: false - local-only mode)
NEXT_PUBLIC_WORKSPACE_WEBSOCKET_ENABLED=false
#
# WebSocket server URL (must match where websocket-server.ts is running)
# Development: ws://localhost:3002
# Production: wss://ws.veritablegames.com or ws://192.168.1.15:3002
NEXT_PUBLIC_WS_URL=ws://localhost:3002
#
# WebSocket server ports (for server-side configuration)
WS_PORT=3002
WS_HEALTH_PORT=3003

# ===== DATABASE CONFIGURATION =====
# Connection pool settings
DB_POOL_SIZE=5
DB_TIMEOUT=30000

# ===== LOGGING CONFIGURATION =====
# Log level: 'debug' | 'info' | 'warn' | 'error'
LOG_LEVEL=info

# ===== SECURITY HEADERS =====
# Content Security Policy settings
CSP_REPORT_URI=/api/security/csp-report
CSP_REPORT_ONLY=false

# ===== RATE LIMITING =====
# Rate limit configurations (requests per time window)
RATE_LIMIT_AUTH_ATTEMPTS=5
RATE_LIMIT_AUTH_WINDOW=900000
RATE_LIMIT_API_REQUESTS=60  
RATE_LIMIT_API_WINDOW=60000


# ===== MONITORING & ANALYTICS =====
# Sentry DSN for error tracking (optional)
SENTRY_DSN=

# Sentry configuration
SENTRY_ENVIRONMENT=development
SENTRY_RELEASE=1.0.0
SENTRY_SAMPLE_RATE=0.1

# Memory monitoring thresholds (in MB)
MEMORY_WARNING_THRESHOLD=500
MEMORY_CRITICAL_THRESHOLD=800

# ===== REDIS CONFIGURATION (OPTIONAL) =====
# Redis for enhanced caching (leave empty to use memory cache)
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=
REDIS_CLUSTER_NODES=localhost:7001,localhost:7002,localhost:7003
REDIS_CLUSTER_ENABLED=false

# ===== EMAIL CONFIGURATION (OPTIONAL) =====
# Email settings for notifications
SMTP_HOST=
SMTP_PORT=587
SMTP_USER=
SMTP_PASSWORD=
SMTP_FROM=noreply@yourdomain.com

# ===== WEBHOOK CONFIGURATION (OPTIONAL) =====
# External webhooks for integrations
WEBHOOK_SECRET=

# ===== DEVELOPMENT SETTINGS =====
# Development-specific settings
ENABLE_MOCK_DATA=false
DEBUG_DATABASE_QUERIES=false
SKIP_CSRF_IN_DEV=false

# ===== GODOT PROJECTS CONFIGURATION =====
# Paths to Godot project files (stored on server via Docker volumes)
#
# Development: SSHFS mount
# GODOT_PROJECTS_PATH=/home/user/mnt/godot-projects
#
# Production: Docker volume mount
# GODOT_PROJECTS_PATH=/app/godot-projects
#
# Default: frontend/godot-projects (local fallback)
GODOT_PROJECTS_PATH=
GODOT_BUILDS_PATH=

# ===== FEATURE FLAGS =====
# Feature toggles
ENABLE_FORUMS=true
ENABLE_WIKI=true
ENABLE_LIBRARY=true
ENABLE_3D_VIEWER=true
ENABLE_WORKSPACE=true
ADMIN_ENABLED=false

# Maintenance mode
MAINTENANCE_MODE=false
MAINTENANCE_MESSAGE="System maintenance in progress"

# ===== BACKUP CONFIGURATION =====
# Automated backup settings
BACKUP_ENABLED=true
BACKUP_RETENTION_DAYS=30
BACKUP_SCHEDULE=daily

# ===== PERFORMANCE SETTINGS =====
# Bundle analysis and optimization
ANALYZE_BUNDLE=false
ENABLE_SOURCE_MAPS=false

# Webpack module replacement configuration
# Set to 'true' if experiencing webpack module loading issues
DISABLE_STYLED_JSX_COMPLETELY=false

# Image optimization
NEXT_IMAGE_DOMAINS=localhost
NEXT_IMAGE_FORMATS=image/webp,image/avif

# ===== API EXTERNAL SERVICES (OPTIONAL) =====
# External API integrations
GITHUB_API_TOKEN=
EXTERNAL_API_BASE_URL=

# ===== ADVANCED SECURITY (PRODUCTION) =====
# Additional security headers
STRICT_TRANSPORT_SECURITY=max-age=31536000; includeSubDomains
X_FRAME_OPTIONS=DENY
X_CONTENT_TYPE_OPTIONS=nosniff
REFERRER_POLICY=strict-origin-when-cross-origin

# ===== NOTES =====
# 1. All secrets should be at least 32 characters long
# 2. Use strong, unique values for each environment
# 3. Regenerate all secrets when deploying to production
# 4. Never commit actual .env.local file to version control
# 5. Use environment-specific values for different deployments

# ===== DONATION SYSTEM CONFIGURATION =====
# BTCPay Server Configuration (Bitcoin/Lightning payments)
# Get these from your BTCPay Server instance at: Dashboard ‚Üí Settings ‚Üí Stores
BTCPAY_SERVER_URL=https://your-btcpay-instance.com
BTCPAY_STORE_ID=your_store_id_here
BTCPAY_API_KEY=your_api_key_here
BTCPAY_WEBHOOK_SECRET=your_webhook_secret_here

# Stripe Configuration (Credit card payments)
# Get test keys from: https://dashboard.stripe.com/test/apikeys
# IMPORTANT: Use test keys (sk_test_* and pk_test_*) for development
# Use live keys (sk_live_* and pk_live_*) ONLY in production
STRIPE_SECRET_KEY=sk_test_your_test_secret_key_here
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_your_test_publishable_key_here

# Stripe Webhook Secret
# Get this after creating webhook endpoint at: https://dashboard.stripe.com/test/webhooks
# Webhook URL: http://localhost:3000/api/donations/stripe/webhook (dev)
#              https://yourdomain.com/api/donations/stripe/webhook (prod)
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret_here

# Base URL for donation redirects (success/cancel pages)
# Development: http://localhost:3000
# Production: https://www.veritablegames.com
NEXT_PUBLIC_BASE_URL=http://localhost:3000

# ===== QUICK SETUP COMMANDS =====
# Generate secrets quickly:
# SESSION_SECRET=$(openssl rand -hex 32)
# CSRF_SECRET=$(openssl rand -hex 32)
# ENCRYPTION_KEY=$(openssl rand -hex 32)